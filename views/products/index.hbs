<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Products | 8 Bit Bazaar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/style-products.css" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

    <!-- Jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        crossorigin="anonymous"></script>

    <!-- Toastr -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- Sweetalert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <header>
        {{> header}}
    </header>
    <main>
        <div class="welcome">
            <span class="welcome-title">Products</span>
        </div>
        <div>
           {{#if (eq currentUser.profile "Admin")}}
                <div style="text-align: center;">
                    <a href="/products/add" class="add-product-btn">Add Product</a>
                    <div>
                        <label for="show-all-products">Show all products</label>
                        <input 
                            class="input-box" 
                            type="checkbox" 
                            id="show-all-products" 
                            name="showAllProducts" 
                            {{#if showAllProducts}}checked{{/if}}
                            onchange="toggleShowAllProducts(this)">
                    </div>
                </div>
            {{/if}}
            {{#if products.length}}
                {{#each products}}
                    <div class="product" id="{{_id}}">
                        {{#if (eq ../currentUser.profile "Admin")}}
                            <div class="admin-actions">
                                <a href="/products/edit/{{_id}}" class="edit-product-btn">Edit</a>
                                <button class="delete-btn" onclick="deleteProduct('{{_id}}')">Delete</button>
                            </div>
                        {{/if}}
                        <div class="product-image-wrapper">
                            <img src="{{picturePath}}" alt="Product Image" class="product-image">
                            {{#if isDeal}}
                                <img src="/images/hot-deal.png" alt="Hot Deal" class="hot-deal">
                            {{/if}}
                        </div>
                        <div class="product-details">
                            <h2 class="product-name">{{name}}
                                {{#if (eq ../currentUser.profile "Admin")}}
                                    {{#if ../showAllProducts}}
                                        <span class="status-text">
                                        ({{#if (eq status "A")}}Active{{else}}Inactive{{/if}})
                                        </span>
                                    {{/if}}
                                {{/if}}
                            </h2>
                            <p class="type">{{type}}</p>
                            <div class="price">
                                <span class="price-old">$ {{price}}</span>
                                <span class="price-new">$ {{calcDiscount price discount}}</span>
                            </div>
                            <span class="product-quantity">Quantity: {{quantityInStock}}</span>
                            <p class="description">{{description}}</p>
                            <button class="add-to-cart-btn" onclick="addToCart('{{_id}}')">Add to cart</button>
                        </div>
                    </div>
                {{/each}}
            {{else}}
                <p>No products available at the moment.</p>
            {{/if}}
        </div>

        <footer>
            {{> footer}}
        </footer>
    </main>

    <script src="/js/scripts.js"></script>
    {{#if (eq currentUser.profile "Admin")}}
        <script>
            function toggleShowAllProducts(checkbox) {
                const showAll = checkbox.checked ? 'true' : 'false';
                const url = new URL(window.location.href);
                url.searchParams.set('showAllProducts', showAll);
                window.location.href = url.toString();
            }
            function deleteProduct(productId) {
                Swal.fire({
                    title: 'Confirm deletion',
                    text: 'Are you sure you want to delete the product? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'No, cancel'
                }).then((result) => {
                    if (result.isConfirmed) {

                        // Create a form element
                        var form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/products/delete';

                        // Create an input element for the order_id
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'id';
                        input.value = productId;

                        // Append the input to the form and the form to the body
                        form.appendChild(input);
                        document.body.appendChild(form);

                        // Submit the form
                        form.submit();
                    }
                });
                
            }
        </script>
    {{/if}}
    <script>
        {{#if successMessage}}
            toastr.options.positionClass = 'toast-bottom-right';
            toastr.success('{{successMessage}}', 'Success');
        {{/if}}
        {{#if errorMessages}}
            toastr.options.positionClass = 'toast-bottom-right';
            toastr.error('{{errorMessages}}', 'Error');
        {{/if}}
    </script>
</body>

</html>
